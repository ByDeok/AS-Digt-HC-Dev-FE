# Security and Audit Rules
Description: Guidelines for Spring Security 6.x, OAuth2, and Audit Logging (Medical Compliance).

## Spring Security 6.x
- **Configuration**: Use Lambda DSL (functional style).
- **State**: Stateless Session Management (`SessionCreationPolicy.STATELESS`).
- **Auth**: JWT (JSON Web Token) or Opaque Token introspection.
- **CSRF**: Disable for REST APIs, but ensure CORS is strictly configured.

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .csrf(AbstractHttpConfigurer::disable)
        .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/api/public/**").permitAll()
            .anyRequest().authenticated()
        );
    return http.build();
}
```

## Audit Logging (SRS REQ-NF-006)
- **Goal**: Track WHO did WHAT on WHICH resource and WHEN.
- **Entity Auditing**: Use `@EntityListeners(AuditingEntityListener.class)` for `createdAt`, `updatedAt`.
- **Business Auditing**:
  - Create a dedicated `AuditLog` entity (see SRS 6.2.7).
  - Use AOP (`@Aspect`) or ApplicationEvents to decouple audit logic from business logic.
  - Must record: `userId`, `actionType` (VIEW, CREATE), `resourceId`, `ipAddress`.

## Sensitive Data
- **PII/PHI**: Encrypt sensitive columns (AES-256) using `@Convert` with JPA AttributeConverter if database encryption is insufficient.
- **Masking**: Mask names/phones in logs (Never log full PII).

## See also
- [300-java-spring-cursor-rules.mdc](300-java-spring-cursor-rules.mdc)
